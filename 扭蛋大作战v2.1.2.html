<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>扭蛋大挑战</title>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
    <!-- 引入学生数据传递脚本 -->
    <script src="studentData.js"></script>
    <style>

.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,105,180,0.3);
    border-radius: 50%;
    border-top-color: #ff69b4;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,105,180,0.3);
    border-radius: 50%;
    border-top-color: #ff69b4;
    animation: spin 1s ease-in-out infinite;
}
@keyframes spin {
    to { transform: rotate(360deg); }
}

        /* 修改学生显示样式 */
    .student-display {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(145deg, #ff88bb, #ff5599);
        padding: 12px 25px;
        border-radius: 20px;
        box-shadow: 0 5px 15px rgba(255, 85, 153, 0.4);
        z-index: 100;
        color: white;
        font-weight: bold;
        animation: fadeIn 0.8s ease-out;
        text-align: center;
        min-width: 300px;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translate(-50%, -30px); }
        to { opacity: 1; transform: translate(-50%, 0); }
    }
    
    .student-name {
        font-size: 1.5em;
        margin-bottom: 5px;
        text-align: center;
        font-family: 'Ma Shan Zheng', cursive;
        text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
    }
    
    .welcome-text {
        font-size: 1em;
        opacity: 0.9;
    }
    /* 添加解析内容的样式 */
.explanation {
    margin-top: 20px;
    padding: 15px;
    background: rgba(255,255,255,0.95);
    border-radius: 15px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    animation: slideIn 0.5s ease-out;
}

@keyframes slideIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.explanation-content h3 {
    color: #ff69b4;
    margin-bottom: 10px;
    font-family: 'Ma Shan Zheng', cursive;
}

.explanation-content p {
    color: #666;
    line-height: 1.6;
    font-size: 1.1em;
}

    /* 音乐控制按钮样式 */
    .music-control {
        position: fixed;
        top: 20px;
        left: 20px;
        width: 40px;
        height: 40px;
        background: linear-gradient(145deg, #ff88bb, #ff5599);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 5px 15px rgba(255,85,153,0.3);
        z-index: 100;
        transition: all 0.3s;
    }

    .music-control:hover {
        transform: scale(1.1);
    }

    .music-control.muted {
        background: linear-gradient(145deg, #cccccc, #999999);
    }

    .music-icon {
        width: 24px;
        height: 24px;
        background-image: url('yinfu.svg');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        filter: brightness(0) invert(1) drop-shadow(0 0 2px rgba(255,255,255,0.8));
    }
    

    /* 难度说明样式 */
    .difficulty-description {
        margin-top: 20px;
        padding: 15px;
        background: rgba(255,255,255,0.9);
        border-radius: 15px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        font-size: 1.1em;
        line-height: 1.6;
        color: #666;
        max-width: 500px;
        text-align: left;
    }
    .difficulty-description span {
        display: block;
        margin: 8px 0;
    }
    
    /* 难度标签样式 */
    .difficulty-badge {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: bold;
        margin-left: 10px;
        color: white;
    }
    .easy-badge {
        background: linear-gradient(145deg, #4caf50, #8bc34a);
    }
    .medium-badge {
        background: linear-gradient(145deg, #ff9800, #ffc107);
    }
    .hard-badge {
        background: linear-gradient(145deg, #f44336, #ff5722);
    }

    /* 计时器动画 */
    @keyframes pulse {
        0% { transform: scale(1); }
        100% { transform: scale(1.1); }
    }

    /* 连击提示 */
    .combo-text {
        position: fixed;
        top: 20%;
        left: 50%;
        transform: translateX(-50%);
        font-size: 2.5em;
        color: #ffd700;
        text-shadow: 0 0 10px rgba(255,215,0,0.5);
        animation: comboPop 0.8s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        opacity: 0;
        pointer-events: none;
    }

    @keyframes comboPop {
        0% { opacity: 0; transform: translate(-50%, 20px) scale(0.5); }
        80% { opacity: 1; transform: translate(-50%, 0) scale(1.2); }
        100% { opacity: 0; transform: translate(-50%, -20px) scale(0.8); }
    }

    /* 粒子效果 */
    .particle {
        position: absolute;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        animation: particleFly 0.8s ease-out forwards;
        pointer-events: none;
    }

    @keyframes particleFly {
        0% { 
            opacity: 1;
            transform: translate(0, 0) scale(1);
        }
        100% { 
            opacity: 0;
            transform: translate(var(--tx), var(--ty)) scale(0.2);
        }
    }
/* 新增金币雨效果 */
.coin {
    position: absolute;
    width: 20px;
    height: 20px;
    background: radial-gradient(circle at 30% 30%, #ffeb3b, #ffc107);
    border-radius: 50%;
    box-shadow: 0 0 10px rgba(255, 193, 7, 0.8);
    z-index: 1000;
    animation: coinFall 1.5s ease-in forwards;
    pointer-events: none;
}

@keyframes coinFall {
    0% {
        transform: translateY(-50vh) rotate(0deg);
        opacity: 1;
    }
    80% {
        opacity: 1;
    }
    100% {
        transform: translateY(100vh) rotate(360deg);
        opacity: 0;
    }
}

/* 解析样式 */
.explanation {
    margin-top: 20px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 15px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
}

.explanation-content {
    color: #666;
    font-size: 1.1em;
    line-height: 1.6;
}

.explanation-content h3 {
    color: #ff69b4;
    margin-bottom: 10px;
    font-family: 'Ma Shan Zheng', cursive;
}

/* 成就徽章样式 */
.achievement {
    position: fixed;
    bottom: 20px;
    left: 20px;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 10px;
    padding: 15px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    display: flex;
    align-items: center;
    transform: translateX(-120%);
    animation: achievementSlide 5s ease-in-out forwards;
    z-index: 1000;
}

.achievement-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    color: white;
    font-size: 1.2em;
}

.achievement-text {
    display: flex;
    flex-direction: column;
}

.achievement-title {
    font-weight: bold;
    color: #333;
}

.achievement-desc {
    font-size: 0.8em;
    color: #666;
}

@keyframes achievementSlide {
    0% { transform: translateX(-120%); }
    15% { transform: translateX(0); }
    85% { transform: translateX(0); }
    100% { transform: translateX(-120%); }
}

/* 烟花动画 */
.firework {
    position: fixed;
    width: 5px;
    height: 5px;
    border-radius: 50%;
    pointer-events: none;
    z-index: 1000;
}

@keyframes fireworkExplode {
    0% { 
        transform: scale(0.1);
        opacity: 1;
        box-shadow: 0 0 0 0px rgba(255, 255, 255, 0.5);
    }
    100% { 
        transform: scale(1);
        opacity: 0;
        box-shadow: 0 0 0 50px rgba(255, 255, 255, 0);
    }
}

/* 扭蛋开启增强动画 */
.gacha-sparkle {
    position: absolute;
    width: 4px;
    height: 15px;
    background: white;
    border-radius: 2px;
    filter: blur(1px);
    opacity: 0;
    animation: sparkleShine 0.6s ease-out forwards;
    transform-origin: center bottom;
}

@keyframes sparkleShine {
    0% { opacity: 0; transform: scale(0); }
    50% { opacity: 1; transform: scale(1); }
    100% { opacity: 0; transform: scale(0.5); }
}

/* 新增浮动气泡 */
.bubble {
    position: fixed;
    width: var(--size);
    height: var(--size);
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.3));
    box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.5);
    animation: bubbleFloat var(--duration) ease-in-out infinite alternate;
    z-index: -1;
    pointer-events: none;
}

@keyframes bubbleFloat {
    0% { transform: translate(0, 0); }
    100% { transform: translate(var(--tx), var(--ty)); }
}

/* 进度条样式 - 移除了动画效果 */
.progress-glow {
    display: none; /* 隐藏进度条光效 */
}

@keyframes progressGlow {
    /* 动画已禁用 */
    0%, 100% { opacity: 0; }
}

/* 新增3D花朵动画 */
@keyframes crack {
    0% { transform: rotate(0) scale(1); }
    30% { transform: rotate(-15deg) scale(1.2); }
    100% { 
        transform: rotate(720deg) scale(0);
        opacity: 0;
    }
}

@keyframes flowerBloom {
    0% { 
        transform: scale(0) rotateX(90deg);
        filter: brightness(1.5);
    }
    70% {
        transform: scale(1.2) rotateX(0deg);
    }
    100% { 
        transform: scale(1) rotateX(0deg);
        filter: brightness(1);
    }
}

.gacha-shell {
    perspective: 1000px;
    width: 100px;
    height: 100px;
}

.gacha-crack {
    background: linear-gradient(145deg, #ff88bb 30%, #ff5599 70%);
    box-shadow: 0 10px 30px rgba(255,85,153,0.3);
}

.flower {
    width: 80px;
    height: 80px;
    animation: flowerBloom 1s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    transform-style: preserve-3d;
}

/* 多层花瓣 */
.petal-outer {
    position: absolute;
    width: 22px;
    height: 35px;
    background: linear-gradient(160deg, #ff4477 20%, #ff2255 80%);
    border-radius: 15px 15px 8px 8px;
    transform-origin: bottom center;
    filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.1));
}

.petal-inner {
    position: absolute;
    width: 18px;
    height: 28px;
    background: linear-gradient(160deg, #ff6699 20%, #ff4477 80%);
    border-radius: 12px 12px 6px 6px;
    transform-origin: bottom center;
}

/* 3D旋转效果 */
.petal-outer {
    transform: rotate(var(--deg)) translateY(-15px) rotateX(30deg);
}

.petal-inner {
    transform: rotate(var(--deg)) translateY(-10px) rotateX(15deg);
}

/* 花瓣动画 */
@keyframes petalFloat {
    0%,100% { transform: rotate(var(--deg)) translateY(-15px) rotateX(30deg); }
    50% { transform: rotate(var(--deg)) translateY(-25px) rotateX(45deg); }
}

/* 花蕊特效 */
.center {
    background: linear-gradient(#ffdd33, #ffcc00);
    box-shadow: 0 0 15px #ffdd3380;
    animation: centerPulse 2s ease-in-out infinite;
}

@keyframes centerPulse {
    0%,100% { transform: translate(-50%, -50%) scale(1); }
    50% { transform: translate(-50%, -50%) scale(1.1); }
}

/* 新增绽放星光 */
.star {
    position: absolute;
    width: 8px;
    height: 8px;
    background: #fff;
    clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
    animation: starTwinkle 0.8s ease-out;
}

@keyframes starTwinkle {
    0% { transform: scale(0); opacity: 0; }
    50% { transform: scale(1.5); opacity: 1; }
    100% { transform: scale(1); opacity: 0; }
}

/* 新增扭蛋打开动画 */
@keyframes crack {
    0% { transform: rotate(0); }
    50% { transform: rotate(-15deg); }
    100% { 
        transform: rotate(0) scale(0.8);
        opacity: 0;
    }
}

@keyframes flowerBloom {
    0% { transform: scale(0) rotate(0deg); }
    50% { transform: scale(1.2) rotate(-15deg); }
    100% { transform: scale(1) rotate(0deg); }
}

.gacha-shell {
    position: relative;
    width: 80px;
    height: 80px;
    cursor: pointer;
}

.gacha-crack {
    position: absolute;
    width: 100%;
    height: 100%;
    background: linear-gradient(145deg, #ff88bb, #ff5599);
    border-radius: 50%;
    animation: crack 0.8s ease-out forwards;
}

.flower {
    position: absolute;
    width: 60px;
    height: 60px;
    animation: flowerBloom 0.8s 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28) both;
    filter: drop-shadow(0 2px 4px rgba(255,85,153,0.3));
}

.petal {
    position: absolute;
    width: 15px;
    height: 25px;
    background: linear-gradient(145deg, #ff6688, #ff3366);
    border-radius: 15px 15px 5px 5px;
    transform-origin: bottom center;
}

.center {
    position: absolute;
    width: 20px;
    height: 20px;
    background: #ffdd33;
    border-radius: 50%;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* 调整打开区域样式 */
.gacha-open-area {
    gap: 30px;
    margin: 40px 0;
}

/* 花瓣定位 */
.petal:nth-child(1) { transform: rotate(0deg) translateY(-10px); }
.petal:nth-child(2) { transform: rotate(45deg) translateY(-10px); }
.petal:nth-child(3) { transform: rotate(90deg) translateY(-10px); }
.petal:nth-child(4) { transform: rotate(135deg) translateY(-10px); }
.petal:nth-child(5) { transform: rotate(180deg) translateY(-10px); }
.petal:nth-child(6) { transform: rotate(225deg) translateY(-10px); }
.petal:nth-child(7) { transform: rotate(270deg) translateY(-10px); }
.petal:nth-child(8) { transform: rotate(315deg) translateY(-10px); }

/* 花瓣动画 */
@keyframes petalFloat {
    0% { transform: translateY(0) rotate(0deg); }
    50% { transform: translateY(-20px) rotate(10deg); }
    100% { transform: translateY(0) rotate(0deg); }
}

.flower:hover .petal {
    animation: petalFloat 1.2s ease-in-out infinite;
}

/* 错题选项样式 */
.wrong-options {
        margin-top: 15px;
        padding: 10px;
        background: #fff5f7;
        border-radius: 10px;
    }
    .wrong-option {
        padding: 8px;
        margin: 5px 0;
        border-radius: 8px;
        position: relative;
        transition: all 0.3s;
    }
    .correct-mark {
        background: #77dd77;
        color: white;
    }
    .wrong-mark {
        background: #ff6961;
        color: white;
    }
    .option-mark {
        display: inline-block;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        text-align: center;
        margin-right: 10px;
    }

        /* 基础样式 */
        body {
            margin: 0;
            padding: 20px;
            background: #ffe6f4;
            font-family: 'Comic Sans MS', cursive;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .quiz-title {
    color: #ff69b4;
    font-family: 'Ma Shan Zheng', cursive;
    font-size: 3.5em; /* 修改处 */
    text-align: center;
    margin: 30px 0;   /* 修改处 */
    text-shadow: 2px 2px #fff;
    animation: titleBounce 1s infinite alternate;
    font-weight: bold; /* 新增 */
}

@media (max-width: 600px) {
    .quiz-title {
        font-size: 2.8em;
        margin: 20px 0;
    }
}

        @keyframes titleBounce {
        from { transform: translateY(0); }
        to { transform: translateY(-5px); }
        }

        /* 界面容器 */
        .screen {
            display: none;
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
        }

        /* 开始界面 */
        #startScreen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
            text-align: center;
        }

        /* 标题样式 */
        .title {
            color: #ff69b4;
            font-size: 3.5em;
            text-shadow: 2px 2px #fff;
            margin-bottom: 40px;
            line-height: 1.2;
        }

        /* 按钮容器 */
        .button-container {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        /* 3D按钮样式 */
        .bubble-btn {
            position: relative;
            padding: 18px 40px;
            background: linear-gradient(145deg, #ff88bb, #ff5599);
            border: none;
            border-radius: 35px;
            color: white;
            font-size: 1.6em;
            cursor: pointer;
            box-shadow: 0 15px 25px -5px rgba(255,85,153,0.4);
            transition: all 0.3s;
        }

        .bubble-btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 25px 35px -5px rgba(255,85,153,0.5);
        }

        /* 进度条样式 */
        .progress-container {
            display: flex;
            align-items: center;
            margin: 20px 0;
            gap: 15px;
        }
        .progress-text {
            color: #ff69b4;
            font-size: 1.2em;
            white-space: nowrap;
        }
        .progress-bar {
            height: 15px;
            background: #ffe0ed;
            border-radius: 10px;
            overflow: hidden;
            flex-grow: 1;
        }
        .progress {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #ff88bb, #ff5599);
            transition: width 0.5s;
        }

        /* 题目样式 */
        .question {
            font-size: 1.8em;
            color: #ff69b4;
            margin: 20px 0;
            text-align: center;
        }

        /* 选项样式 */
        .option {
            display: block;
            margin: 15px;
            padding: 20px;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        .correct-answer {
            background: #77dd77;
            color: white;
        }
        .wrong-answer {
            background: #ff6961;
            color: white;
        }

        /* 反馈提示 */
        .answer-tip {
            text-align: center;
            color: #ff4444;
            margin: 15px 0;
            font-size: 1.2em;
        }

        /* 按钮位置 */
        #backBtn {
            position: fixed;
            bottom: 30px;
            left: 30px;
            display: none;
        }
        #nextBtn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: none;
        }

        /* 结算界面 */
        .score-text {
            font-family: 'Ma Shan Zheng', cursive;
            color: #ff0000;
            font-size: 5em;
            text-align: center;
            margin: 20px 0;
        }
        .score-line {
            border-bottom: 4px solid #ff0000;
            width: 200px;
            margin: 0 auto 30px;
        }
        .score-emoji {
            font-size: 2.5em;
            color: #ff69b4;
            text-align: center;
            margin: 20px 0;
            font-family: 'Ma Shan Zheng', cursive;
            text-shadow: 1px 1px #fff;
        }

        /* 错题界面 */
        #wrongScreen {
            padding: 20px;
        }
        .wrong-list {
            max-height: 60vh;
            overflow-y: auto;
            margin: 20px 0;
            padding: 10px;
            border: 2px solid #ff88bb;
            border-radius: 15px;
        }
        .wrong-item {
            margin: 15px 0;
            padding: 20px;
            background: white;
            border-radius: 15px;
        }

        /* 扭蛋系统样式 */
        .gacha-counter {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            padding: 10px 20px;
            background: rgba(255,255,255,0.9);
            border-radius: 30px;
            box-shadow: 0 5px 15px rgba(255,85,153,0.3);
            z-index: 100;
        }
        .gacha-icon {
            width: 40px;
            height: 40px;
            margin-right: 10px;
            background: linear-gradient(145deg, #ff88bb, #ff5599);
            border-radius: 50%;
            border: 2px solid white;
            position: relative;
        }
        .gacha-icon::after {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            width: 10px;
            height: 10px;
            background: rgba(255,255,255,0.8);
            border-radius: 50%;
        }

        @keyframes gachaGet {
            0% { transform: scale(0) rotate(-180deg); }
            50% { transform: scale(1.2) rotate(0deg); }
            100% { transform: scale(1) rotate(360deg); }
        }
        .gacha-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 60px;
            height: 60px;
            background: linear-gradient(145deg, #ff88bb, #ff5599);
            border-radius: 50%;
            animation: gachaGet 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
            z-index: 200;
        }

        .gacha-result {
            text-align: center;
            margin: 20px 0;
        }
        .gacha-result-box {
            display: inline-flex;
            align-items: center;
            padding: 15px 30px;
            background: white;
            border-radius: 50px;
            cursor: pointer;
            transition: 0.3s;
        }
        .gacha-result-box:hover {
            transform: scale(1.05);
        }
        .gacha-open-area {
            display: none;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin: 30px 0;
        }
        .opened-gacha {
            width: 80px;
            height: 80px;
            background: linear-gradient(145deg, #ff88bb, #ff5599);
            border-radius: 50%;
            animation: gachaOpen 0.6s ease-out both;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2em;
            box-shadow: 0 8px 20px rgba(255,85,153,0.3);
        }
        .export-btn {
            width: 40%;
            padding: 12px;
            background: #13c2c2;
            border: none;
            color: white;
            border-radius: 5px;
            margin-top: 20px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .export-btn:hover {
            background: #08979c;
        }
        @keyframes gachaOpen {
            0% { transform: scale(0) rotate(-180deg); opacity: 0; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- 音乐控制按钮 -->
    <div id="musicControl" class="music-control">
        <div class="music-icon"></div>
    </div>
     <!-- 修改学生显示区域 -->
     <div id="studentDisplay" class="student-display" style="display: none;">
        <div class="student-name"></div>
        <div class="welcome-text">欢迎您来参加挑战！</div>
    </div>

    <!-- 背景音乐 -->
    <audio id="bgm" src="bgm.mp3" autoplay loop></audio>


    <script>
        // 确保在页面完全加载后立即执行
        window.onload = function() {
            // 获取学生数据
            let selectedStudent = null;
            
            // 尝试从localStorage获取数据（优先）
            const storedStudent = localStorage.getItem('selectedStudent');
            if (storedStudent) {
                try {
                    selectedStudent = JSON.parse(storedStudent);
                    console.log('从localStorage获取到学生数据:', selectedStudent);
                } catch (e) {
                    console.error('解析学生数据失败:', e);
                }
            }
            
            // 如果localStorage没有数据，再尝试从StudentData获取
            if (!selectedStudent || !selectedStudent.name) {
                if (typeof StudentData !== 'undefined' && StudentData.getStudent) {
                    selectedStudent = StudentData.getStudent();
                    console.log('从StudentData获取到学生数据:', selectedStudent);
                }
            }
            
            // 如果有学生数据，显示学生区域
            if (selectedStudent && selectedStudent.name) {
                const studentDisplay = document.getElementById('studentDisplay');
                if (studentDisplay) {
                    const studentName = studentDisplay.querySelector('.student-name');
                    if (studentName) {
                        // 显示学生姓名加"同学"称呼
                        studentName.textContent = selectedStudent.name + " 同学";
                        
                        // 强制显示学生区域
                        studentDisplay.style.display = 'block';
                        
                        console.log('学生数据显示成功:', selectedStudent.name);
                    } else {
                        console.error('未找到学生姓名显示元素');
                    }
                } else {
                    console.error('未找到学生显示区域');
                }
            } else {
                console.log('未找到有效的学生数据');
            }
        };
    </script>
    <script>

async function getAIAdvice() {
    const adviceContainer = document.getElementById('aiAdviceContainer');
    const adviceContent = document.getElementById('aiAdviceContent');
    const loadingSpinner = document.getElementById('aiLoading');
    
    // 显示加载动画
    adviceContainer.style.display = 'block';
    adviceContent.innerHTML = '';
    loadingSpinner.style.display = 'block';
    

    // 优化后的提示词（每条建议30字左右）
    const prompt = `根据答题结果用中文给出3条简明学习建议（每条30字左右）：
得分：${score}/100 | 错误：${wrongAnswers.length}道 | 难度：${getDifficultyName(currentDifficulty)}

要求：
1. 直接指出主要薄弱环节
2. 给出具体改进建议
3. 推荐实用学习资源
4. 语言精炼，避免空话

格式示例：
1. 需加强：古诗意象分析（错3题）
2. 建议：每天对比分析2组相似意象
3. 资源：观看《唐诗意象精讲》视频课`;


    try {
        const response = await fetch("https://2af4a66a.r7.cpolar.top/api/generate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                model: "llama3.1:8b",
                prompt: prompt,
                stream: true
            }),
        });

        if (!response.ok) throw new Error("请求失败");
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullResponse = "";
        
        loadingSpinner.style.display = 'none';
        
        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            const chunk = decoder.decode(value);
            const lines = chunk.split('\n').filter(line => line.trim() !== '');
            
            for (const line of lines) {
                try {
                    const data = JSON.parse(line);
                    fullResponse += data.response;
                    // 格式化显示，保留换行
                    adviceContent.innerHTML = fullResponse.replace(/\n/g, '<br>');
                } catch (e) {
                    console.error("解析JSON失败:", e);
                }
            }
        }
    } catch (error) {
        loadingSpinner.style.display = 'none';
        adviceContent.innerHTML = `获取建议失败: ${error.message}<br>请检查Ollama服务是否运行`;
        console.error("调用Ollama失败:", error);
    }
}


// 调用 Ollama 生成解析
async function askAIForExplanation() {
    const currentQ = questionBank[currentQuestion];
    
    // 获取当前显示的选项顺序
    const displayedOptions = [];
    const options = document.querySelectorAll('.option');
    options.forEach(opt => {
        const optionText = opt.textContent.trim().substring(2); // 去除"A. "这样的前缀
        displayedOptions.push(optionText);
    });
    
    // 找到当前显示的正确答案字母
    let correctDisplayLetter = '';
    for (const key in currentQ.optionsMapping) {
        if (currentQ.optionsMapping[key] === currentQ.answer) {
            correctDisplayLetter = key;
            break;
        }
    }
    
    const prompt = `请用中文解析以下题目，要求：
1. 先用1句话说明正确答案（标注选项字母）
2. 再用1-2句话解释原因
3. 语言生动易懂，适合学生理解
4. 总字数控制在50字左右

题目：${currentQ.question}
选项：${displayedOptions.map((opt, i) => `${String.fromCharCode(65 + i)}. ${opt}`).join(" ")}
正确答案：${correctDisplayLetter}

示例格式：
"正确答案是B。因为诗中'疑'字表示'好像'，把月光比作白霜，这是常见的比喻手法。"`;

    const aiTip = document.getElementById('answerTip');
    aiTip.innerHTML = `<div class="loading-spinner"></div> AI 思考中...`;

    try {
        const response = await fetch("https://2af4a66a.r7.cpolar.top/api/generate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                model: "llama3.1:8b",
                prompt: prompt,
                stream: true,
            }),
        });

        if (!response.ok) {
            throw new Error(`HTTP错误! 状态码: ${response.status}`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullResponse = "🤖 AI 解析：";

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            const chunk = decoder.decode(value);
            const lines = chunk.split('\n').filter(line => line.trim() !== '');
            
            for (const line of lines) {
                try {
                    const data = JSON.parse(line);
                    fullResponse += data.response;
                    aiTip.innerHTML = fullResponse;
                } catch (e) {
                    console.error("解析JSON失败:", e);
                }
            }
        }
    } catch (error) {
        aiTip.innerHTML = `AI解析失败: ${error.message}`;
        console.error("调用Ollama失败:", error);
    }
}

    // 音乐控制功能
    const musicControl = document.getElementById('musicControl');
    const bgm = document.getElementById('bgm');

    musicControl.addEventListener('click', () => {
        if (bgm.paused) {
            bgm.play();
            musicControl.classList.remove('muted');
        } else {
            bgm.pause();
            musicControl.classList.add('muted');
        }
    });
   // 添加学生数据显示功能
   document.addEventListener('DOMContentLoaded', function() {
        // 获取学生数据
        let selectedStudent = null;
        
        // 尝试从StudentData获取数据
        if (typeof StudentData !== 'undefined' && StudentData.getStudent) {
            selectedStudent = StudentData.getStudent();
        }
        
        // 如果StudentData未定义或未获取到数据，则直接从localStorage获取
        if (!selectedStudent || !selectedStudent.name) {
            const storedStudent = localStorage.getItem('selectedStudent');
            if (storedStudent) {
                try {
                    selectedStudent = JSON.parse(storedStudent);
                } catch (e) {
                    console.error('解析学生数据失败:', e);
                }
            }
        }
        
        // 如果有学生数据，显示学生区域
        if (selectedStudent && selectedStudent.name) {
            const studentDisplay = document.getElementById('studentDisplay');
            if (studentDisplay) {
                const studentName = studentDisplay.querySelector('.student-name');
                if (studentName) {
                    // 显示学生姓名加"同学"称呼
                    studentName.textContent = selectedStudent.name + " 同学";
                    
                    // 显示学生区域
                    studentDisplay.style.display = 'block';
                    
                    console.log('学生数据加载成功:', selectedStudent.name);
                } else {
                    console.error('未找到学生姓名显示元素');
                }
            } else {
                console.error('未找到学生显示区域');
            }
        } else {
            console.log('未找到有效的学生数据');
        }
    });
    </script>

    <!-- 1. 按钮音效 -->
    <audio id="btnSound" src="btn.mp3" style="display:none"></audio>
    <!-- 2. 正确音效 -->
    <audio id="correctSound" src="correct.mp3" style="display:none"></audio>
    <!-- 3. 错误音效 -->
    <audio id="wrongSound" src="wrong.mp3" style="display:none"></audio>
    <!-- 4. 扭蛋开花音效 -->
    <audio id="gachaSound" src="gacha.mp3" style="display:none"></audio>
        <!-- 新增音效 -->
        <audio id="comboSound" src="combo.mp3" style="display:none"></audio>
        <audio id="achievementSound" src="achievement.mp3" style="display:none"></audio>
        <audio id="fireworkSound" src="firework.mp3" style="display:none"></audio>
        <audio id="coinSound" src="coin.mp3" style="display:none"></audio>
    

    <!-- 扭蛋计数器 -->
    <div class="gacha-counter">
        <div class="gacha-icon"></div>
        <span id="gachaCount">0</span>
    </div>

    <!-- 开始界面 -->
    <div id="startScreen" class="screen">
        <h1 class="title">扭蛋大挑战</h1>
<button class="export-btn" onclick="window.open('课堂互助班级系统v2.0.html', '_blank')" style="margin-top: 10px; background: #722ed1;">
   课堂互助班级系统
</button>
<button class="export-btn" onclick="window.open('题库管理器.html', '_blank')" style="margin-top: 10px; background: #1890ff;">
    题库管理器
 </button><br>

        <div class="button-container">
            <button class="bubble-btn" onclick="selectDifficulty('easy')">简单模式</button>
            <button class="bubble-btn" onclick="selectDifficulty('medium')">中等模式</button>
            <button class="bubble-btn" onclick="selectDifficulty('hard')">困难模式</button>
        </div>
        <div class="difficulty-description" id="difficultyDesc">
            <span>👉 选择难度等级开始游戏</span>
        </div>
    </div>

    <!-- 答题界面 -->
    <div id="quizScreen" class="screen">
        <h2 class="quiz-title">🌟 答题集蛋大作战</h2>
        <div class="progress-container">
            <div class="progress-text" id="progressText">第1/10题</div>
            <div class="progress-bar">
                <div class="progress" id="progress"></div>
            </div>
        </div>
        <div class="question" id="question"></div>
        <div id="options"></div>
        <div id="answerTip" class="answer-tip"></div>
        <!-- 新增 AI 解析按钮 -->
        <button id="aiExplainBtn" class="bubble-btn" onclick="askAIForExplanation()" style="margin: 10px auto; display: none;">
             🤖 AI 解析本题
        </button>
        <button id="backBtn" class="bubble-btn" onclick="backToStart()">返回</button>
        <button id="nextBtn" class="bubble-btn" onclick="nextQuestion()">下一题</button>
    </div>

    <!-- 结算界面 -->
    <div id="resultScreen" class="screen">
        <div class="score-emoji" id="scoreEmoji"></div>
        <div class="score-text" id="scoreText">100</div>
        <div class="score-line"></div>
        <div class="gacha-result">
            <div class="gacha-result-box" onclick="openGacha()">
                <div class="gacha-icon" style="width:60px;height:60px;"></div>
                <span style="margin-left:15px;font-size:1.5em;">×</span>
                <span id="resultGachaCount" style="font-size:2em;margin-left:10px;">0</span>
            </div>
        </div>
        <div class="gacha-open-area" id="gachaOpenArea"></div>
        <div class="button-container">
            <button id="viewWrongBtn" class="bubble-btn" onclick="showWrong()">查看错题</button>
            <button class="bubble-btn" onclick="getAIAdvice()">获取AI学习建议</button>  <!-- 新增按钮 -->
            <button class="bubble-btn" onclick="restartQuiz()">重新开始</button>
        </div>

        <div id="aiAdviceContainer" style="display:none; margin-top:20px; padding:20px; background:rgba(255,255,255,0.9); border-radius:15px;">
            <h3 style="color:#ff69b4; text-align:center;">AI学习建议</h3>
            <div id="aiAdviceContent" style="margin-top:10px;"></div>
            <div class="loading-spinner" id="aiLoading" style="margin:20px auto; display:none;"></div>
        </div>

    </div>

    <!-- 错题界面 -->
    <div id="wrongScreen" class="screen">
        <h2 class="title">错题回顾</h2>
        <div class="wrong-list" id="wrongList"></div>
        <div class="button-container">
            <button class="bubble-btn" onclick="backToResult()">确定</button>
        </div>
    </div>

    <script>
        let combo = 0;
        let maxCombo = 0;
        let currentQuestion = 0;
        let score = 0;
        let wrongAnswers = [];
        let isAnswered = false;
        let gachaCount = 0;
        let collectedGachas = [];
        let currentDifficulty = 'medium'; // 默认难度
        let timeLimit = 0; // 答题时间限制（毫秒），0表示无限制
        let timer = null; // 计时器
        let timeRemaining = 0; // 剩余时间

        // 难度相关配置
        const difficultySettings = {
            easy: {
                timeLimit: 0, // 无时间限制
                scorePerQuestion: 10,
                description: '简单模式：无时间限制，基础题目，适合初学者。'
            },
            medium: {
                timeLimit: 20000, // 20秒
                scorePerQuestion: 15,
                description: '中等模式：20秒答题时间，中等难度题目，适合有一定基础的学习者。'
            },
            hard: {
                timeLimit: 10000, // 10秒
                scorePerQuestion: 20,
                description: '困难模式：10秒答题时间，高难度题目，适合挑战自我的高手。'
            }
        };
        
        // 成就系统
        let achievements = [
            { id: 'combo3', title: '连击大师', description: '达成3连击', unlocked: false, icon: '🔥' },
            { id: 'combo5', title: '无敌连击', description: '达成5连击', unlocked: false, icon: '⚡' },
            { id: 'perfect', title: '完美答题', description: '全部答对', unlocked: false, icon: '🌟' },
            { id: 'gacha5', title: '扭蛋收藏家', description: '收集5个扭蛋', unlocked: false, icon: '🎁' },
            { id: 'speed', title: '闪电答题', description: '5秒内答对题目', unlocked: false, icon: '⏱️' },
            { id: 'hardMode', title: '挑战大师', description: '完成困难模式', unlocked: false, icon: '🏆' }
        ];
        
        // 简单难度题库
        let easyQuestions = [    {
      "question": "疑是地上霜中“疑”字的正确解释是。",
      "options": ["怀疑", "好像", "确定", "否定"],
      "answer": "B",
      "explanation": "此处用比喻手法，将月光比作白霜，\"疑\"在此处意为\"好像\"，表达诗人对月光的诗意联想而非实际怀疑。"
    },
    {
      "question": "举头望明月中“举头”的意思是：",
      "options": ["抬头", "低头", "摇头", "回头"],
      "answer": "A",
      "explanation": "\"举头\"是古汉语表达，\"举\"即抬起，生动展现诗人从沉思到仰望的连续动作。"
    },
    {
      "question": "《静夜思》属于以下哪种诗歌体裁？",
      "options": ["七言律诗", "五言绝句", "乐府诗", "宋词"],
      "answer": "B",
      "explanation": "全诗四句，每句五字，符合绝句\"短小精悍、即景抒情\"的特点，是五言绝句的典范之作。"
    },
    {
      "question": "诗人“低头思故乡”时，最可能联想到的是：",
      "options": ["故乡的繁华街道", "故乡的亲人或往事", "故乡的战争场景", " 故乡的朝廷政事"],
      "answer": "B",
      "explanation": "李白此时身处异乡，秋夜寂静的环境最易引发对亲人朋友和往昔生活的思念。"
    },
    {
      "question": "诗中“明月”的意象常被用来象征：",
      "options": ["孤独与清冷", "团圆与思念", "时间流逝", "自然之美"],
      "answer": "B",
      "explanation": "明月高悬普照的特性，使其成为连接游子与故乡的情感纽带，承载着团圆的期盼。"
    },
    {
      "question": "以下哪句诗不是李白所作？",
      "options": ["飞流直下三千尺", "桃花潭水深千尺", "两个黄鹂鸣翠柳", "朝辞白帝彩云间"],
      "answer": "C",
      "explanation": "\"两个黄鹂鸣翠柳\"出自杜甫《绝句》，与李白豪放风格形成鲜明对比。"
    },
    {
      "question": "李白创作《静夜思》时最可能身处：",
      "options": ["家乡的宅院中", "异乡的客栈里", "皇宫的宴席上", "边塞的战场中"],
      "answer": "B",
      "explanation": "创作背景为诗人26岁旅居扬州患病期间，客栈的孤寂环境催生了思乡之情。"
    },
    {
      "question": "全诗未直接提到“秋”，却让人联想到秋夜，是因为：",
      "options": ["\"霜\"多出现于秋季", "\"明月\"代表秋天", "\"床\"是秋日家具", "\"故乡\"在秋天"],
      "answer": "A",
      "explanation": "霜的意象具有强烈季节性暗示，古代\"疑霜\"的描写多与秋夜相关联。"
    },
    {
      "question": "关于《静夜思》的版本，正确的是：",
      "options": ["首句为“床前明月光”", "李白最初写于宋代", "诗中“床”指现代睡床", "全诗押仄声韵"],
      "answer": "A",
      "explanation": "明代版本始作\"床前明月光\"，虽非李白原稿，但已成为最广为流传的标准版本。"
    },
    {
      "question": "《静夜思》的语言特点是：",
      "options": ["华丽繁复", "朴实自然", "幽默讽刺", "艰深晦涩"],
      "answer": "B",
      "explanation": "全诗用最浅显的20个字构建深远意境，体现李白\"清水出芙蓉\"的语言美学。"
    },
    {
      "question": "李白被后世称为：",
      "options": ["诗圣", "诗仙", "诗佛", "诗鬼"],
      "answer": "B",
      "explanation": "因其诗歌充满奇幻想象和飘逸气质，贺知章赞其\"谪仙人\"，故得\"诗仙\"雅号。"
    }
  

        ];

        // 中等难度题库
        let mediumQuestions = [
        {
      "question": "《静夜思》中“举头望明月”与“低头思故乡”形成了什么修辞手法？",
      "options": ["对偶", "排比", "反复", "设问"],
      "answer": "A",
      "explanation": "两句在结构上对仗工整，\"举头\"对\"低头\"，\"望明月\"对\"思故乡\"，形成空间动作与心理活动的对称美。"
    },
    {
      "question": "下列哪个成语与李白的《静夜思》主题最接近？",
      "options": ["乐不思蜀", "思归其雌", "思如涌泉", "思念故乡"],
      "answer": "D",
      "explanation": "全诗围绕\"思乡\"主题展开，\"思念故乡\"直接呼应诗中\"低头思故乡\"的核心情感。"
    },
    {
      "question": "《静夜思》中“床前明月光”的“床”指的是什么？",
      "options": ["睡觉的床", "古代坐卧的床榻", "窗台", "门槛"],
      "answer": "B",
      "explanation": "唐代的\"床\"指可坐可卧的家具，结合全诗意境，应理解为诗人起身坐在床榻上的状态。"
    },
    {
      "question": "《静夜思》是哪个朝代的作品？",
      "options": ["汉代", "唐代", "宋代", "元代"],
      "answer": "B",
      "explanation": "李白（701年－762年）是盛唐诗人，此诗创作于开元十四年（726年），正值唐朝鼎盛时期。"
    },
    {
      "question": "《静夜思》的创作背景最可能是：",
      "options": ["边塞征战", "宫廷宴会", "旅途思乡", "山水游览"],
      "answer": "C",
      "explanation": "根据年谱记载，此诗作于李白首次离蜀漫游期间，在扬州旅舍养病时的思乡之作。"
    },
    {
      "question": "李白被称为”诗仙“，与他齐名的”诗圣“是谁？",
      "options": ["杜甫", "白居易", "王维", "苏轼"],
      "answer": "A",
      "explanation": "杜甫因关注现实、风格沉郁，与李白的浪漫主义形成互补，被并称为\"李杜\"。"
    },
    {
      "question": "《静夜思》属于哪种诗歌体裁？",
      "options": ["七言律诗", "五言绝句", "七言绝句", "五言律诗"],
      "answer": "B",
      "explanation": "全诗共四句，每句五字，押平声韵，符合五言绝句的基本特征。"
    },
    {
      "question": "《静夜思》中”疑是地上霜“的”疑“字表达了诗人的什么心理？",
      "options": ["怀疑", "猜测", "误认", "困惑"],
      "answer": "C",
      "explanation": "此处是诗人将月光错觉为白霜的瞬间感受，展现从朦胧到清醒的心理变化过程。"
    },
    {
      "question": "李白的《静夜思》创作于他的哪个人生阶段？",
      "options": ["少年时期", "壮年漫游时期", "仕途失意时期", "晚年隐居时期"],
      "answer": "C",
      "explanation": "创作时李白尚未进入宫廷，正处于漫游求仕未果的阶段，带有迷茫与乡愁的双重情感。"
    },
    {
      "question": "《静夜思》中”明月“意象在中国古典诗歌中常常象征：",
      "options": ["孤独", "团圆", "自由", "权力"],
      "answer": "B",
      "explanation": "明月具有时空穿越性，既照游子又照故乡，成为跨越空间的情感联结符号。"
    },
    {
      "question": "《静夜思》的艺术特点不包括：",
      "options": ["语言朴素", "意境优美", "情感真挚", "用典繁复"],
      "answer": "D",
      "explanation": "本诗最大特点就是白描手法，全诗无一处用典，以最简语言传达最深情感。"
    },
    {
      "question": "《静夜思》中”思故乡“表达了诗人怎样的情感？",
      "options": ["喜悦", "愤怒", "思念", "恐惧"],
      "answer": "C",
      "explanation": "在寂静月夜触发的乡愁，是中国古代游子诗中最典型的情感表达。"
    },
    {
      "question": "李白与杜甫的友谊被后人称为：",
      "options": ["刎颈之交", "管鲍之交", "忘年之交", "莫逆之交"],
      "answer": "D",
      "explanation": "两人相差11岁却结下深厚友谊，相互赠诗多首，堪称心意相通的至交。"
    },
    {
      "question": "李白的诗歌风格被概括为：",
      "options": ["含蓄隽永", "沉郁顿挫", "豪放飘逸", "清新自然"],
      "answer": "C",
      "explanation": "其诗想象奇特、情感奔放，具有\"黄河之水天上来\"的磅礴气势与超凡想象力。"
    },
    {
      "question": "《静夜思》中”举头望明月“一句中“举头”的含义是：",
      "options": ["抬起头", "仰望", "思考", "惊讶"],
      "answer": "A",
      "explanation": "\"举头\"是具象化的身体语言，通过动作描写展现心理活动的变化轨迹。"
    }

        ];
        
        // 困难难度题库
        let hardQuestions = [
        {
      "question": "《静夜思》在唐诗选本《唐诗三百首》中的首句是什么？",
      "options": ["床前明月光", "窗前明月光", "床头明月光", "窗外明月光"],
      "answer": "A",
      "explanation": "虽然宋代版本有\"床前看月光\"的异文，但《唐诗三百首》作为清代选本采用流传最广的\"床前明月光\"版本。"
    },
    {
      "question": "李白《静夜思》的真实创作地点最可能是：",
      "options": ["长安", "洛阳", "扬州", "蜀地"],
      "answer": "C",
      "explanation": "根据《李太白年谱》，此诗作于开元十四年（726年）秋，李白时年26岁旅居扬州，正值病中思乡情切之时。"
    },
    {
      "question": "《静夜思》中“举头望明月，低头思故乡”体现了哪种艺术手法？",
      "options": ["动静结合", "虚实对比", "情景交融", "以上都是"],
      "answer": "D",
      "explanation": "既有抬头/低头的动作对比（动），又有月光/乡思的虚实结合，最终达到情景交融的完美境界。"
    },
    {
      "question": "李白的《静夜思》在文学史上的地位是：",
      "options": ["开创了新的诗歌流派", "成为五言绝句的典范", "影响了后世无数文人", "被誉为千古绝唱"],
      "answer": "C",
      "explanation": "虽非开创性作品，但其\"自然天成\"的特点成为乡愁诗的范式，对中日韩汉诗创作产生深远影响。"
    },
    {
      "question": "《静夜思》中“疑是地上霜”一句运用了什么修辞手法？",
      "options": ["比喻", "拟人", "夸张", "借代"],
      "answer": "A",
      "explanation": "本体是月光，喻体是秋霜，通过视觉相似性构建比喻，增强画面感和情感浓度。"
    },
    {
      "question": "李白的《静夜思》与下列哪位诗人的作品风格最为接近？",
      "options": ["杜甫", "王维", "孟浩然", "白居易"],
      "answer": "C",
      "explanation": "孟浩然同属山水田园诗派，其《宿建德江》\"野旷天低树，江清月近人\"同样具有白描传情的特点。"
    },
    {
      "question": "《静夜思》中“低头思故乡”一句中的“思”字在古汉语中的词性是：",
      "options": ["名词", "动词", "形容词", "副词"],
      "answer": "B",
      "explanation": "此处\"思\"读作sī，表示思念的心理动作，在句中作谓语动词使用。"
    },
    {
      "question": "《静夜思》的艺术成就主要体现在：",
      "options": ["意境深远", "语言精炼", "情感真挚", "以上都是"],
      "answer": "D",
      "explanation": "三位一体的艺术成就：20字构建完整意境，语言毫无雕琢痕迹，情感具有人类共性。"
    },
    {
      "question": "李白的《静夜思》与下列哪首诗在主题上最为相似？",
      "options": ["杜甫《春望》", "王维《鹿柴》", "孟浩然《春晓》", "王昌龄《芙蓉楼送辛渐》"],
      "answer": "A",
      "explanation": "虽然《春望》更宏大，但两诗都通过具体意象（月光/草木）表达深沉的家国之思。"
    },
    {
      "question": "《静夜思》中“明月光”与“地上霜”在色彩上形成了什么对比？",
      "options": ["明暗对比", "冷暖对比", "虚实对比", "动静对比"],
      "answer": "A",
      "explanation": "月光皎白与秋霜银白的明度相似性形成视觉类比，而月光清冷的质感与霜的寒意在色彩心理学上都属于冷色调，构成双重呼应。"
    },
    {
      "question": "《静夜思》中“举头望明月”一句中“望”字的含义是：",
      "options": ["看见", "仰望", "期望", "思念"],
      "answer": "B",
      "explanation": "\"望\"在此处既是物理动作的仰望，又暗含心理层面的期盼，具有双重语义。"
    },
    {
      "question": "李白的《静夜思》在结构上属于：",
      "options": ["起承转合式", "总分总式", "并列式", "递进式"],
      "answer": "C",
      "explanation": "四句呈现平行关系：前两句写景，后两句抒情，形成意象并列而非传统起承转合结构。"
    },
    {
      "question": "《静夜思》中“床前明月光”一句中的“光”字在诗中的作用是：",
      "options": ["点明时间", "渲染氛围", "引出下文", "以上都是"],
      "answer": "D",
      "explanation": "\"光\"既说明是夜晚（时间），营造清冷氛围（环境），又为后续\"疑霜\"提供视觉基础（结构）。"
    },
    {
      "question": "李白的《静夜思》与下列哪首诗在写作手法上最为相似？",
      "options": ["王维《山居秋暝》", "杜甫《登高》", "孟浩然《宿建德江》", "王之涣《登鹳雀楼》"],
      "answer": "D",
      "explanation": "二者都使用白描手法，《登鹳雀楼》\"白日依山尽\"与\"举头望明月\"同样通过简单意象构建宏大空间感。"
    },
    {
      "question": "《静夜思》中“疑是地上霜”一句中的“霜”字在诗中的作用是：",
      "options": ["暗示季节", "形容月光", "象征孤独", "以上都是"],
      "answer": "B",
      "explanation": "主要功能是通过比喻描写月光质感，季节暗示是附带效果，孤独象征需结合全诗理解。"
    }

        ];
        
        // 答题计时器
        let questionStartTime = 0;
        
        // 显示题目解析
        function showExplanation(question) {
    
    const existingExplanation = document.querySelector('.explanation');
    if (existingExplanation) existingExplanation.remove();
    
    // 如果有解析内容才显示
    if(question.explanation) {
        const explanationDiv = document.createElement('div');
        explanationDiv.className = 'explanation';
        explanationDiv.innerHTML = `
            <div class="explanation-content">
                <h3>📚 题目解析</h3>
                <p>${question.explanation}</p>
            </div>
        `;
        document.getElementById('answerTip').after(explanationDiv);
    }
}
        // 创建背景气泡
        function createBubbles() {
            for(let i = 0; i < 15; i++) {
                const bubble = document.createElement('div');
                bubble.className = 'bubble';
                const size = 20 + Math.random() * 60;
                const duration = 5 + Math.random() * 10;
                const tx = -50 + Math.random() * 100;
                const ty = -50 + Math.random() * 100;
                
                bubble.style.cssText = `
                    --size: ${size}px;
                    --duration: ${duration}s;
                    --tx: ${tx}px;
                    --ty: ${ty}px;
                    left: ${Math.random() * 100}vw;
                    top: ${Math.random() * 100}vh;
                    opacity: ${0.1 + Math.random() * 0.3};
                `;
                
                document.body.appendChild(bubble);
            }
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('startScreen').style.display = 'flex';
            createBubbles();
            
            // 添加进度条动画
            const progressBar = document.querySelector('.progress-bar');
            // 移除进度条光效动画
            // const progressGlow = document.createElement('div');
            // progressGlow.className = 'progress-glow';
            // progressBar.appendChild(progressGlow);
        });

        // 选择难度
        function selectDifficulty(difficulty) {
            document.getElementById('btnSound').play();
            currentDifficulty = difficulty;
            
            // 更新难度说明
            const descEl = document.getElementById('difficultyDesc');
            descEl.innerHTML = `<span>${difficultySettings[difficulty].description}</span>`;
            
            // 显示开始按钮
            const buttonContainer = document.querySelector('.button-container');
            buttonContainer.innerHTML = `
                <button class="bubble-btn" onclick="startQuiz()">开始挑战</button>
                <button class="bubble-btn" onclick="showDifficultySelection()">返回选择</button>
            `;
        }
        
        // 返回难度选择
        function showDifficultySelection() {
            document.getElementById('btnSound').play();
            const buttonContainer = document.querySelector('.button-container');
            buttonContainer.innerHTML = `
                <button class="bubble-btn" onclick="selectDifficulty('easy')">简单模式</button>
                <button class="bubble-btn" onclick="selectDifficulty('medium')">中等模式</button>
                <button class="bubble-btn" onclick="selectDifficulty('hard')">困难模式</button>
            `;
            
            document.getElementById('difficultyDesc').innerHTML = `<span>👉 选择难度等级开始游戏</span>`;
        }
        
        // 开始挑战
        async function startQuiz() {   
            document.getElementById('btnSound').play(); // 按钮音效
            document.getElementById('startScreen').style.display = 'none'; 
            document.getElementById('quizScreen').style.display = 'none'; 
            
            // 根据难度选择题目
            let filteredQuestions = [];
            
            if (currentDifficulty === 'easy') {
                filteredQuestions = easyQuestions;
            } else if (currentDifficulty === 'medium') {
                filteredQuestions = mediumQuestions;
            } else {
                filteredQuestions = hardQuestions;
            }
            
            // 随机选择10道题目
            questionBank = filteredQuestions.sort(() => 0.5 - Math.random()).slice(0, 10);
            
            currentQuestion = 0; 
            score = 0; 
            wrongAnswers = [];
            gachaCount = 0;
            collectedGachas = [];
            combo = 0;
            maxCombo = 0;
            
            // 设置时间限制
            timeLimit = difficultySettings[currentDifficulty].timeLimit;
            
            // 重置成就
            achievements.forEach(a => a.unlocked = false);
            
            document.getElementById('gachaCount').textContent = '0';
            document.getElementById('gachaOpenArea').innerHTML = '';
            document.getElementById('gachaOpenArea').style.display = 'none';
            
            document.getElementById('quizScreen').style.display = 'block'; 
            showQuestion(); 
        }

        // 显示题目
        function showQuestion() {
            // 每次显示新题目前移除解析
            const existingExplanation = document.querySelector('.explanation');
            if (existingExplanation) existingExplanation.remove();
            isAnswered = false;
            const q = questionBank[currentQuestion];
            
            // 添加难度标签
            let difficultyBadge = '';
            if (currentDifficulty === 'easy') {
                difficultyBadge = '<span class="difficulty-badge easy-badge">简单</span>';
            } else if (currentDifficulty === 'medium') {
                difficultyBadge = '<span class="difficulty-badge medium-badge">中等</span>';
            } else {
                difficultyBadge = '<span class="difficulty-badge hard-badge">困难</span>';
            }
            
            document.getElementById('question').innerHTML = q.question + difficultyBadge;
            document.getElementById('progressText').textContent = `第${currentQuestion + 1}/10题`;
            document.getElementById('progress').style.width = `${(currentQuestion + 1) * 10}%`;
            document.getElementById('answerTip').textContent = '';
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('backBtn').style.display = currentQuestion === 0 ? 'block' : 'none';
            
            // 如果有时间限制，添加计时器
            if (timeLimit > 0) {
                // 创建或更新计时器显示
                if (!document.getElementById('timer')) {
                    const timerEl = document.createElement('div');
                    timerEl.id = 'timer';
                    timerEl.style.cssText = `
                        position: fixed;
                        top: 17px;
                        left: 80px;
                        background: rgba(255,255,255,0.9);
                        padding: 10px 20px;
                        border-radius: 30px;
                        font-size: 1.2em;
                        color: #ff69b4;
                        box-shadow: 0 5px 15px rgba(255,85,153,0.3);
                    `;
                    document.body.appendChild(timerEl);
                }
                
                // 重置计时器
                if (timer) clearInterval(timer);
                timeRemaining = timeLimit;
                updateTimer();
                
                timer = setInterval(() => {
                    timeRemaining -= 100;
                    updateTimer();
                    
                    if (timeRemaining <= 0) {
                        clearInterval(timer);
                        if (!isAnswered) {
                            // 时间到，自动判定为错误
                            document.getElementById('wrongSound').play();
                            document.getElementById('answerTip').textContent = `时间到！正确答案：${q.answer}`;
                            document.getElementById('nextBtn').style.display = 'block';
                            
                            // 标记选项
                            const options = document.querySelectorAll('.option');
                            options.forEach((opt, index) => {
                                const optLetter = String.fromCharCode(65 + index);
                                if (optLetter === q.answer) {
                                    opt.classList.add('correct-answer');
                                }
                            });
                            
                            // 记录错题
                            if (!wrongAnswers.some(item => item.question.question === q.question)) {
                                wrongAnswers.push({ question: q, selected: 'timeout' });
                            }
                            
                            isAnswered = true;
                            combo = 0;
                        }
                    }
                }, 100);
            }

            // 创建选项数组，包含选项内容和原始选项字母
            let optionsArray = q.options.map((opt, index) => {
                return {
                    text: opt,
                    originalLetter: String.fromCharCode(65 + index)
                };
            });
            
            // 随机打乱选项顺序
            optionsArray = optionsArray.sort(() => 0.5 - Math.random());
            
            // 保存当前题目的选项映射关系，用于后续答案判断
            q.optionsMapping = {};
            
            let optionsHtml = '';
            optionsArray.forEach((opt, index) => {
                const displayLetter = String.fromCharCode(65 + index);
                // 记录显示字母到原始字母的映射
                q.optionsMapping[displayLetter] = opt.originalLetter;
                
                optionsHtml += `
                    <label class="option" onclick="selectAnswer('${displayLetter}')">
                        <input type="radio" name="answer" value="${displayLetter}">
                        ${displayLetter}. ${opt.text}
                    </label>
                `;
            });
            document.getElementById('options').innerHTML = optionsHtml;
            
            // 记录开始答题时间
            questionStartTime = Date.now();

            document.getElementById('aiExplainBtn').style.display = 'block'; // 新增
        }

        function selectAnswer(selected) {
            if (isAnswered) return;
            isAnswered = true;

            const q = questionBank[currentQuestion];
            const options = document.querySelectorAll('.option');
            const selectedElement = document.querySelector(`input[value="${selected}"]`).parentElement;
            
            // 将显示的选项字母映射回原始字母
            const originalSelected = q.optionsMapping[selected];
            
            // 添加点击坐标获取
            const rect = selectedElement.getBoundingClientRect();
            const clickX = rect.left + rect.width/2;
            const clickY = rect.top + rect.height/2;

            options.forEach((opt, index) => {
                const displayLetter = String.fromCharCode(65 + index);
                const originalLetter = q.optionsMapping[displayLetter];
                
                if (originalLetter === q.answer) {
                    opt.classList.add('correct-answer');
                    if (originalSelected === q.answer) {
                        createParticles(clickX, clickY); // 正确时生成粒子
                    }
                }
                if (displayLetter === selected && originalSelected !== q.answer) {
                    opt.classList.add('wrong-answer');
                }
            });

            // 显示题目解析
            showExplanation(q);

            if (originalSelected === q.answer) {
                // 正确时移除解析显示
                const existingExplanation = document.querySelector('.explanation');
                if (existingExplanation) existingExplanation.remove();
        
                combo++;
                maxCombo = Math.max(maxCombo, combo);
                showComboText();
                document.getElementById('correctSound').play();
                createGachaAnimation();
                collectedGachas.push(currentQuestion);
                
                // 根据难度获取分数
                score += difficultySettings[currentDifficulty].scorePerQuestion;
                document.getElementById('answerTip').textContent = '回答正确！';
                
                // 检查答题速度成就
                const answerTime = (Date.now() - questionStartTime) / 1000;
                if (answerTime < 5) {
                    unlockAchievement('speed');
                }
                
                // 检查连击成就
                if (combo >= 3) unlockAchievement('combo3');
                if (combo >= 5) unlockAchievement('combo5');
                
                // 金币雨效果
                createCoinRain();
                
                setTimeout(nextQuestion, 1000);
            } else {
                // 错误时显示解析
                showExplanation(q);
                combo = 0;
                document.getElementById('wrongSound').play();
                // 找到正确选项的显示字母
                const correctDisplayLetter = Object.keys(q.optionsMapping).find(
                key => q.optionsMapping[key] === q.answer);
                document.getElementById('answerTip').textContent = `正确答案：${correctDisplayLetter}`;
                document.getElementById('nextBtn').style.display = 'block';
                if (!wrongAnswers.some(item => item.question.question === q.question)) {
                    wrongAnswers.push({ question: q, selected: originalSelected });
                }
            }
        }

        // 新增连击提示函数
        function showComboText() {
            const comboEl = document.createElement('div');
            comboEl.className = 'combo-text';
            
            if (combo > 1) {
                comboEl.textContent = `连击 x${combo} 🎉`;
                if (combo > 2) document.getElementById('comboSound').play();
            } else {
                comboEl.textContent = '完美！';
            }
            
            if (combo > 3) {
                comboEl.style.color = '#ff6b6b';
                comboEl.style.textShadow = '0 0 15px rgba(255,107,107,0.7)';
                comboEl.style.fontSize = '3em';
            }
            
            document.body.appendChild(comboEl);
            setTimeout(() => comboEl.remove(), 800);
        }

        // 新增粒子效果函数
        function createParticles(x, y) {
            const colors = ['#ffd700', '#ff6b6b', '#4ecdc4', '#45b7d1'];
            for(let i = 0; i < 12; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                // 随机参数
                const angle = (Math.random() * 360) * Math.PI/180;
                const distance = 80 + Math.random() * 40;
                const tx = Math.cos(angle) * distance;
                const ty = Math.sin(angle) * distance;
                
                particle.style.cssText = `
                    --tx: ${tx}px;
                    --ty: ${ty}px;
                    left: ${x}px;
                    top: ${y}px;
                    background: ${colors[Math.floor(Math.random()*colors.length)]};
                    animation-delay: ${i*0.02}s;
                `;
                
                document.body.appendChild(particle);
                setTimeout(() => particle.remove(), 800);
            }
        }
        
        // 新增金币雨效果
        function createCoinRain() {
            if (combo < 2) return; // 只有连击大于2才触发
            
            const coinCount = Math.min(combo * 3, 20); // 根据连击数量增加金币，但最多20个
            document.getElementById('coinSound').play();
            
            for(let i = 0; i < coinCount; i++) {
                const coin = document.createElement('div');
                coin.className = 'coin';
                
                coin.style.cssText = `
                    left: ${10 + Math.random() * 80}vw;
                    animation-delay: ${i * 0.1}s;
                    animation-duration: ${1 + Math.random()}s;
                `;
                
                document.body.appendChild(coin);
                setTimeout(() => coin.remove(), 2000);
            }
        }
        
        // 新增成就解锁函数
        function unlockAchievement(id) {
            const achievement = achievements.find(a => a.id === id);
            if (!achievement || achievement.unlocked) return;
            
            achievement.unlocked = true;
            document.getElementById('achievementSound').play();
            
            const achievementEl = document.createElement('div');
            achievementEl.className = 'achievement';
            achievementEl.innerHTML = `
                <div class="achievement-icon">${achievement.icon}</div>
                <div class="achievement-text">
                    <div class="achievement-title">${achievement.title}</div>
                    <div class="achievement-desc">${achievement.description}</div>
                </div>
            `;
            
            document.body.appendChild(achievementEl);
            setTimeout(() => achievementEl.remove(), 5000);
        }

        // 创建扭蛋动画增强版
        function createGachaAnimation() {
            const gacha = document.createElement('div');
            gacha.className = 'gacha-animation';
            
            // 添加闪光效果
            for(let i = 0; i < 8; i++) {
                const sparkle = document.createElement('div');
                sparkle.className = 'gacha-sparkle';
                sparkle.style.transform = `rotate(${i * 45}deg)`;
                sparkle.style.animationDelay = `${i * 0.05}s`;
                gacha.appendChild(sparkle);
            }
            
            setTimeout(() => {
                const counterPos = document.querySelector('.gacha-counter').getBoundingClientRect();
                gacha.style.transition = 'all 0.6s cubic-bezier(0.18, 0.89, 0.32, 1.28)';
                gacha.style.left = `${counterPos.left + 20}px`;
                gacha.style.top = `${counterPos.top + 20}px`;
                gacha.style.transform = 'scale(0.3)';
                
                setTimeout(() => {
                    gacha.remove();
                    gachaCount++;
                    document.getElementById('gachaCount').textContent = gachaCount;
                    
                    // 检查扭蛋收藏家成就
                    if (gachaCount >= 5) {
                        unlockAchievement('gacha5');
                    }
                }, 600);
            }, 800);

            document.body.appendChild(gacha);
        }

        // 更新计时器显示
        function updateTimer() {
            const timerEl = document.getElementById('timer');
            if (!timerEl) return;
            
            const seconds = Math.ceil(timeRemaining / 1000);
            timerEl.textContent = `⏱️ ${seconds}秒`;
            
            // 时间少于5秒时变红
            if (seconds <= 5) {
                timerEl.style.color = '#ff0000';
                timerEl.style.animation = 'pulse 0.5s infinite alternate';
            } else {
                timerEl.style.color = '#ff69b4';
                timerEl.style.animation = 'none';
            }
        }
        
        // 下一题
        function nextQuestion() {
            document.getElementById('btnSound').play(); // 按钮音效
            
            // 清除计时器
            if (timer) {
                clearInterval(timer);
                timer = null;
            }
            
            if (currentQuestion < 9) {
                currentQuestion++;
                showQuestion();
            } else {
                // 移除计时器显示
                const timerEl = document.getElementById('timer');
                if (timerEl) timerEl.remove();
                
                showResult();
            }
        }

        // 显示结果增强版
        function showResult() {
            document.getElementById('quizScreen').style.display = 'none';
            document.getElementById('resultScreen').style.display = 'block';
            document.getElementById('scoreText').textContent = score;
            document.getElementById('resultGachaCount').textContent = collectedGachas.length;

            const emoji = document.getElementById('scoreEmoji');
            emoji.textContent = `最大连击：${maxCombo}次 🏆 [${getDifficultyName(currentDifficulty)}]`;

            if (score >= 80) {
                emoji.textContent += ' 太棒了！✨';
            } else if (score >= 60) {
                emoji.textContent += ' 继续努力哦！💪';
            } else {
                emoji.textContent += ' 别灰心继续加油哦！🌱';
            }
            
            // 检查完美答题成就
            if (score === 100) {
                unlockAchievement('perfect');
            }
            
            // 检查困难模式成就
            if (currentDifficulty === 'hard' && score >= 60) {
                unlockAchievement('hardMode');
            }
            
            document.getElementById('viewWrongBtn').style.display = 
                score === 100 ? 'none' : 'block';
                
            // 创建结算烟花
            createFireworks();
        }
        
        // 新增烟花效果
        function createFireworks() {
            document.getElementById('fireworkSound').play();
            
            const fireworkCount = Math.max(5, Math.floor(score / 10));
            const colors = ['#ff5252', '#ffeb3b', '#2196f3', '#4caf50', '#e040fb', '#ff9800'];
            
            for(let i = 0; i < fireworkCount; i++) {
                setTimeout(() => {
                    const x = 100 + Math.random() * (window.innerWidth - 200);
                    const y = 100 + Math.random() * (window.innerHeight - 200);
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    
                    const firework = document.createElement('div');
                    firework.className = 'firework';
                    firework.style.cssText = `
                        left: ${x}px;
                        top: ${y}px;
                        background: ${color};
                        box-shadow: 0 0 30px ${color};
                        animation: fireworkExplode 1s ease-out forwards;
                    `;
                    
                    document.body.appendChild(firework);
                    
                    // 创建烟花粒子
                    for(let j = 0; j < 20; j++) {
                        const particle = document.createElement('div');
                        particle.className = 'particle';
                        
                        const angle = (Math.random() * 360) * Math.PI/180;
                        const distance = 100 + Math.random() * 100;
                        const tx = Math.cos(angle) * distance;
                        const ty = Math.sin(angle) * distance;
                        
                        particle.style.cssText = `
                            --tx: ${tx}px;
                            --ty: ${ty}px;
                            left: ${x}px;
                            top: ${y}px;
                            background: ${color};
                            animation-delay: 0.1s;
                            animation-duration: 1s;
                        `;
                        
                        document.body.appendChild(particle);
                        setTimeout(() => particle.remove(), 1000);
                    }
                    
                    setTimeout(() => firework.remove(), 1000);
                }, i * 300);
            }
        }
        
        // 获取难度名称
        function getDifficultyName(difficulty) {
            switch(difficulty) {
                case 'easy': return '简单模式';
                case 'medium': return '中等模式';
                case 'hard': return '困难模式';
                default: return '未知模式';
            }
        }
        
        // 添加重新开始函数
        function restartQuiz() {
            document.getElementById('btnSound').play(); // 按钮音效
            document.getElementById('resultScreen').style.display = 'none';
            document.getElementById('startScreen').style.display = 'flex';
            
            // 重置所有状态
            currentQuestion = 0;
            score = 0;
            combo = 0;
            maxCombo = 0;
            wrongAnswers = [];
            gachaCount = 0;
            collectedGachas = [];
            document.getElementById('gachaCount').textContent = '0';
            
            // 显示难度选择
            showDifficultySelection();
        }

        // 添加返回结果界面的函数
        function backToResult() {
            document.getElementById('btnSound').play(); // 按钮音效
            document.getElementById('wrongScreen').style.display = 'none';
            document.getElementById('resultScreen').style.display = 'block';
        }
        
        // 添加在restartQuiz函数前
        function backToStart() {
            document.getElementById('btnSound').play(); // 按钮音效
            document.getElementById('quizScreen').style.display = 'none';
            document.getElementById('startScreen').style.display = 'flex';
            
            // 清除计时器
            if (timer) {
                clearInterval(timer);
                timer = null;
            }
            
            // 移除计时器显示
            const timerEl = document.getElementById('timer');
            if (timerEl) timerEl.remove();
            
            // 重置所有进度状态
            currentQuestion = 0;
            score = 0;
            wrongAnswers = [];
            gachaCount = 0;
            collectedGachas = [];
            
            // 重置界面显示
            document.getElementById('gachaCount').textContent = '0';
            document.getElementById('progress').style.width = '0%';
            document.getElementById('progressText').textContent = '第1/10题';
            
            // 清除选项样式
            const options = document.querySelectorAll('.option');
            options.forEach(opt => {
                opt.classList.remove('correct-answer', 'wrong-answer');
            });
            
            // 显示难度选择
            showDifficultySelection();
        }

        // 修改打开扭蛋函数
        // 修改扭蛋开启函数，将学生名字与扭蛋关联
    function openGacha() {
        document.getElementById('gachaSound').play(); // 扭蛋开花音效
        const area = document.getElementById('gachaOpenArea');
        area.style.display = 'flex';
        
        // 获取学生数据
        let studentName = '';
        if (typeof StudentData !== 'undefined') {
            const selectedStudent = StudentData.getStudent();
            if (selectedStudent && selectedStudent.name) {
                studentName = selectedStudent.name;
            }
        }
        
        area.innerHTML = collectedGachas.map((_, i) => {
            return `
                <div class="gacha-shell" style="animation-delay:${i*0.2}s">
                    <!-- 裂开动画 -->
                    <div class="gacha-crack"></div>
                    
                    <!-- 花朵本体 -->
                    <div class="flower">
                        <!-- 花蕊 -->
                        <div class="center">${studentName}</div>
                        
                        <!-- 外层花瓣 -->
                        ${Array(8).fill().map((_,j)=>`
                            <div class="petal-outer" style="--deg:${j*45}deg">
                                <div class="petal-inner"></div>
                            </div>
                        `).join('')}
                        
                        <!-- 绽放星光 -->
                        ${Array(6).fill().map((_,j)=>`
                            <div class="star" style="
                                left:${Math.random()*70+15}%;
                                top:${Math.random()*70+15}%;
                                animation-delay:${j*0.1}s">
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }).join('');
        
        // 添加额外的星光效果
        setTimeout(() => {
            const shells = document.querySelectorAll('.gacha-shell');
            shells.forEach(shell => {
                const rect = shell.getBoundingClientRect();
                createParticles(rect.left + rect.width/2, rect.top + rect.height/2);
            });
        }, 500);
    }

        // 修改showWrong函数以适应新的选项映射
        function showWrong() {
            document.getElementById('btnSound').play(); // 按钮音效
            const wrongList = document.getElementById('wrongList');
            wrongList.innerHTML = wrongAnswers.map((item, index) => {
                let optionsHtml = item.question.options.map((opt, idx) => {
                    const optLetter = String.fromCharCode(65 + idx);
                    let markClass = '';
                    let textClass = '';
                    
                    if (optLetter === item.question.answer) {
                        markClass = 'correct-mark';
                        textClass = 'correct-answer';
                    } else if (optLetter === item.selected) {
                        markClass = 'wrong-mark';
                        textClass = 'wrong-answer';
                    }
                    
                    return `
                        <div class="wrong-option ${textClass}">
                            <span class="option-mark ${markClass}">${optLetter}</span>
                            ${opt}
                        </div>
                    `;
                }).join('');

                let selectedText = item.selected === 'timeout' ? 
                    '<span style="color:#ff4444;">❌ 时间到未作答</span>' : 
                    `<span style="color:#ff4444;">❌ 你的选择：${item.selected}</span>`;

                return `
                    <div class="wrong-item">
                        <div style="font-weight:bold; color:#ff69b4;">${index + 1}. ${item.question.question}</div>
                        <div class="wrong-options">
                            ${optionsHtml}
                        </div>
                        <div style="margin-top:10px;">
                            ${selectedText}
                            <span style="color:#77dd77; margin-left:15px;">✅ 正确答案：${item.question.answer}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('resultScreen').style.display = 'none';
            document.getElementById('wrongScreen').style.display = 'block';
        }
    </script>
</body>
</html>